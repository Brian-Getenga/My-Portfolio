{% extends 'base.html' %}
{% load static %}

{% block title %}Blog — {{ site_settings.site_name }}{% endblock %}
{% block meta_description %}Articles, tutorials, and insights on web development, programming, and technology.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<style>
    .blog-hero { background: #0a0f2e; position: relative; overflow: hidden; }
    .blog-hero-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(201,147,42,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(201,147,42,0.04) 1px, transparent 1px); background-size: 80px 80px; }
    .breadcrumb { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; }
    .breadcrumb a { color: rgba(255,255,255,0.4); transition: color 0.2s; }
    .breadcrumb a:hover { color: #fbbf24; }
    .breadcrumb .sep { color: rgba(255,255,255,0.2); }
    .breadcrumb .current { color: #fbbf24; }

    /* Search bar */
    .search-bar {
        position: relative; max-width: 520px;
    }
    .search-bar input {
        width: 100%; padding: 0.875rem 1rem 0.875rem 3rem;
        background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12); border-radius: 4px;
        color: white; font-size: 0.9rem; font-family: 'DM Sans', sans-serif;
        transition: all 0.25s ease; outline: none;
    }
    .search-bar input::placeholder { color: rgba(255,255,255,0.35); }
    .search-bar input:focus { border-color: rgba(201,147,42,0.5); background: rgba(255,255,255,0.1); }
    .search-bar .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.35); font-size: 0.8rem; }
    .search-bar button { position: absolute; right: 0.375rem; top: 50%; transform: translateY(-50%); padding: 0.5rem 1.25rem; background: linear-gradient(135deg, #c9932a, #fbbf24); color: #0a0f2e; font-size: 0.8rem; font-weight: 700; border-radius: 2px; transition: all 0.2s; }
    .search-bar button:hover { filter: brightness(1.1); }

    /* Filter chips */
    .filter-chip {
        padding: 0.4rem 1rem; border-radius: 100px; font-size: 0.75rem; font-weight: 600;
        border: 1px solid rgba(0,0,0,0.08); background: white; color: #64748b;
        cursor: pointer; transition: all 0.25s ease; white-space: nowrap;
    }
    .dark .filter-chip { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: #94a3b8; }
    .filter-chip:hover { border-color: rgba(201,147,42,0.4); color: #c9932a; }
    .filter-chip.active { background: #0a0f2e; color: #fbbf24; border-color: #0a0f2e; }
    .dark .filter-chip.active { background: rgba(201,147,42,0.15); color: #fbbf24; border-color: rgba(201,147,42,0.4); }

    /* Featured post */
    .featured-post { position: relative; border-radius: 4px; overflow: hidden; aspect-ratio: 16/8; }
    .featured-post img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s cubic-bezier(0.4,0,0.2,1); }
    .featured-post:hover img { transform: scale(1.04); }
    .featured-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(10,15,46,0.97) 0%, rgba(10,15,46,0.5) 50%, transparent 100%); }
    .featured-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 2.5rem; }

    /* Blog card */
    .blog-card {
        background: white; border: 1px solid rgba(0,0,0,0.06); border-radius: 4px;
        overflow: hidden; transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
    }
    .dark .blog-card { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.07); }
    .blog-card:hover { transform: translateY(-5px); box-shadow: 0 24px 64px rgba(0,0,0,0.12); border-color: rgba(201,147,42,0.2); }
    .dark .blog-card:hover { box-shadow: 0 24px 64px rgba(0,0,0,0.4); }
    .blog-card-img { overflow: hidden; aspect-ratio: 16/9; }
    .blog-card-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s cubic-bezier(0.4,0,0.2,1); }
    .blog-card:hover .blog-card-img img { transform: scale(1.07); }

    /* Sidebar widget */
    .sidebar-widget { padding: 1.5rem; border: 1px solid rgba(0,0,0,0.06); border-radius: 4px; background: white; }
    .dark .sidebar-widget { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.07); }
    .widget-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: #c9932a; margin-bottom: 1rem; }

    /* Tag cloud */
    .tag-item { padding: 0.3rem 0.75rem; border-radius: 100px; font-size: 0.7rem; font-weight: 600; border: 1px solid rgba(0,0,0,0.08); background: white; color: #64748b; cursor: pointer; transition: all 0.2s; display: inline-block; }
    .dark .tag-item { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: #94a3b8; }
    .tag-item:hover { border-color: rgba(201,147,42,0.5); color: #c9932a; transform: translateY(-1px); }

    /* Sticky sidebar */
    @media (min-width: 1024px) { .sidebar-sticky { position: sticky; top: 6rem; } }

    /* Popular post item */
    .pop-post-item { display: flex; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(0,0,0,0.04); }
    .dark .pop-post-item { border-color: rgba(255,255,255,0.04); }
    .pop-post-item:last-child { border-bottom: none; padding-bottom: 0; }
    .pop-post-thumb { width: 4rem; height: 4rem; border-radius: 4px; overflow: hidden; flex-shrink: 0; }
    .pop-post-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .pop-post-item:hover .pop-post-thumb img { transform: scale(1.1); }

    /* Pagination */
    .page-link { padding: 0.5rem 0.875rem; background: white; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; font-size: 0.8rem; font-weight: 600; color: #64748b; transition: all 0.2s; }
    .dark .page-link { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: #94a3b8; }
    .page-link:hover { border-color: rgba(201,147,42,0.4); color: #c9932a; }
    .page-link.active { background: #0a0f2e; color: #fbbf24; border-color: #0a0f2e; }
    .dark .page-link.active { background: rgba(201,147,42,0.15); border-color: rgba(201,147,42,0.4); }
</style>
{% endblock %}

{% block content %}

<!-- ==================== HERO ==================== -->
<section class="blog-hero pt-28 pb-20">
    <div class="blog-hero-grid"></div>
    <div class="absolute top-16 left-0 right-0 h-px" style="background: linear-gradient(90deg, transparent 5%, rgba(201,147,42,0.3) 50%, transparent 95%);"></div>
    
    <div class="relative z-10 max-w-7xl mx-auto px-6 lg:px-8">
        <nav class="breadcrumb mb-12" data-aos="fade-down">
            <a href="{% url 'home' %}">Home</a>
            <span class="sep">/</span>
            <span class="current">Blog</span>
        </nav>
        
        <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-8">
            <div class="max-w-2xl">
                <div style="display:inline-flex;align-items:center;gap:.5rem;padding:.4rem 1rem;border:1px solid rgba(201,147,42,0.3);background:rgba(201,147,42,0.06);border-radius:100px;font-size:.7rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:#fbbf24;" class="mb-8" data-aos="fade-up">
                    <i class="fas fa-pen-nib"></i> Insights & Tutorials
                </div>
                <h1 class="font-display text-5xl lg:text-7xl font-bold text-white mb-4 leading-tight" data-aos="fade-up" data-aos-delay="80">
                    The <span class="italic" style="color:transparent;-webkit-text-stroke:1px rgba(201,147,42,0.6);">Blog</span>
                </h1>
                <p class="text-slate-400 text-lg" data-aos="fade-up" data-aos-delay="140">Articles on web development, programming, and technology</p>
            </div>
            
            <!-- Search -->
            <div data-aos="fade-up" data-aos-delay="180">
                <form method="get" class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search articles…">
                    <button type="submit">Search</button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- ==================== FILTER BAR ==================== -->
<div class="sticky top-16 z-40 bg-white/95 dark:bg-navy-950/95 backdrop-blur-xl border-b border-slate-100 dark:border-white/5 shadow-sm">
    <div class="max-w-7xl mx-auto px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between gap-4">
            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-none">
                <a href="{% url 'blog' %}" class="filter-chip {% if not current_tag %}active{% endif %}">All Posts</a>
                {% for tag in tags|slice:":10" %}
                <a href="?tag={{ tag }}" class="filter-chip {% if current_tag == tag %}active{% endif %}">#{{ tag }}</a>
                {% endfor %}
            </div>
            <form method="get" class="flex items-center gap-2 flex-shrink-0">
                {% if current_tag %}<input type="hidden" name="tag" value="{{ current_tag }}">{% endif %}
                {% if request.GET.search %}<input type="hidden" name="search" value="{{ request.GET.search }}">{% endif %}
                <select name="sort" onchange="this.form.submit()" class="text-xs font-semibold px-3 py-2 bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-sm text-slate-600 dark:text-slate-400 cursor-pointer outline-none">
                    <option value="-published_date" {% if current_sort == '-published_date' %}selected{% endif %}>Latest</option>
                    <option value="-views" {% if current_sort == '-views' %}selected{% endif %}>Popular</option>
                    <option value="title" {% if current_sort == 'title' %}selected{% endif %}>A–Z</option>
                </select>
            </form>
        </div>
    </div>
</div>

<!-- ==================== MAIN CONTENT ==================== -->
<section class="py-20 bg-slate-50 dark:bg-navy-900/30">
    <div class="max-w-7xl mx-auto px-6 lg:px-8">
        <div class="grid lg:grid-cols-3 gap-10">
            
            <!-- Posts -->
            <div class="lg:col-span-2">
                
                <!-- Featured Post -->
                {% if featured_post and not request.GET.search and not current_tag %}
                <article class="mb-8" data-aos="fade-up">
                    <a href="{{ featured_post.get_absolute_url }}" class="block featured-post group">
                        {% if featured_post.featured_image %}
                        <img src="{{ featured_post.featured_image.url }}" alt="{{ featured_post.title }}" loading="eager">
                        {% else %}
                        <div class="w-full h-full bg-navy-900"></div>
                        {% endif %}
                        <div class="featured-overlay"></div>
                        <div class="featured-content">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-xs font-bold uppercase tracking-widest px-2.5 py-1 bg-gold-500 text-navy-900 rounded-sm">Featured</span>
                                <span class="text-xs text-white/50 font-mono">{{ featured_post.published_date|date:"M d, Y" }} · {{ featured_post.reading_time }} min</span>
                            </div>
                            <h2 class="font-display text-2xl lg:text-3xl font-bold text-white mb-3 group-hover:text-gold-300 transition-colors leading-tight line-clamp-2">{{ featured_post.title }}</h2>
                            <p class="text-slate-400 text-sm line-clamp-2 mb-5">{{ featured_post.excerpt }}</p>
                            <span class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-widest text-gold-400 group-hover:gap-3 transition-all">
                                Read Article <i class="fas fa-arrow-right"></i>
                            </span>
                        </div>
                    </a>
                </article>
                {% endif %}
                
                <!-- Grid posts -->
                {% if posts %}
                <div class="space-y-6">
                    {% for post in posts %}
                    <article class="blog-card group" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:'1' }}00">
                        <a href="{{ post.get_absolute_url }}" class="lg:flex">
                            <!-- Image -->
                            <div class="blog-card-img lg:w-72 lg:flex-shrink-0 h-52 lg:h-auto">
                                {% if post.featured_image %}
                                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" loading="lazy">
                                {% else %}
                                <div class="w-full h-full bg-gradient-to-br from-navy-800 to-navy-900 flex items-center justify-center">
                                    <i class="fas fa-newspaper text-4xl text-white/20"></i>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Content -->
                            <div class="p-6 flex-1 min-w-0 flex flex-col">
                                <div class="flex items-center gap-4 font-mono text-xs text-slate-400 mb-3">
                                    <span>{{ post.published_date|date:"M d, Y" }}</span>
                                    <span>{{ post.reading_time }} min</span>
                                    <span><i class="fas fa-eye mr-1"></i>{{ post.views }}</span>
                                </div>
                                <h3 class="font-display text-lg font-bold text-slate-900 dark:text-white mb-2 leading-snug group-hover:text-gold-600 dark:group-hover:text-gold-400 transition-colors line-clamp-2">{{ post.title }}</h3>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-2 leading-relaxed flex-1">{{ post.excerpt }}</p>
                                
                                {% if post.tags.all %}
                                <div class="flex flex-wrap gap-1.5 mb-4">
                                    {% for tag in post.tags.all|slice:":3" %}
                                    <span class="text-xs px-2 py-0.5 font-mono bg-slate-100 dark:bg-white/5 text-slate-500 dark:text-slate-400 rounded-sm">#{{ tag.name }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <div class="flex items-center justify-between pt-4 border-t border-slate-100 dark:border-white/5">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-gold-500/20 border border-gold-500/30 flex items-center justify-center text-xs font-bold text-gold-600">
                                            {{ post.author.first_name|first }}
                                        </div>
                                        <span class="text-xs font-semibold text-slate-700 dark:text-slate-300">{{ post.author.get_full_name }}</span>
                                    </div>
                                    <span class="inline-flex items-center gap-1.5 text-xs font-semibold uppercase tracking-widest text-slate-900 dark:text-white group-hover:text-gold-600 dark:group-hover:text-gold-400 transition-colors">
                                        Read <i class="fas fa-arrow-right"></i>
                                    </span>
                                </div>
                            </div>
                        </a>
                    </article>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <div class="flex justify-center gap-2 mt-12" data-aos="fade-up">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}" class="page-link">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    {% endif %}
                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <span class="page-link active">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}" class="page-link">{{ num }}</a>
                    {% endif %}
                    {% endfor %}
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}" class="page-link">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
                
                {% else %}
                <!-- Empty -->
                <div class="text-center py-24" data-aos="zoom-in">
                    <div class="w-20 h-20 bg-slate-100 dark:bg-white/5 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-search text-2xl text-slate-400"></i>
                    </div>
                    <h3 class="font-display text-2xl font-bold text-slate-900 dark:text-white mb-3">
                        {% if request.GET.search %}No results for "{{ request.GET.search }}"{% else %}No Articles Yet{% endif %}
                    </h3>
                    <p class="text-slate-500 text-sm mb-6">{% if request.GET.search %}Try different keywords or browse all articles.{% else %}Check back soon — content is coming.{% endif %}</p>
                    <a href="{% url 'blog' %}" class="btn-primary mx-auto"><span>View All Posts</span></a>
                </div>
                {% endif %}
            </div>
            
            <!-- Sidebar -->
            <aside class="sidebar-sticky space-y-6" data-aos="fade-left">
                
                <!-- Popular Posts -->
                {% if popular_posts %}
                <div class="sidebar-widget">
                    <div class="widget-title">Popular</div>
                    {% for post in popular_posts %}
                    <div class="pop-post-item">
                        <div class="pop-post-thumb">
                            <a href="{{ post.get_absolute_url }}">
                                {% if post.featured_image %}
                                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" loading="lazy">
                                {% else %}
                                <div class="w-full h-full bg-navy-800"></div>
                                {% endif %}
                            </a>
                        </div>
                        <div class="flex-1 min-w-0">
                            <a href="{{ post.get_absolute_url }}" class="text-xs font-semibold text-slate-800 dark:text-white hover:text-gold-600 dark:hover:text-gold-400 transition-colors leading-snug line-clamp-2 block mb-1">{{ post.title }}</a>
                            <div class="text-xs font-mono text-slate-400 flex gap-3">
                                <span><i class="fas fa-eye mr-1"></i>{{ post.views }}</span>
                                <span><i class="fas fa-heart mr-1"></i>{{ post.likes }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Tags -->
                {% if tags %}
                <div class="sidebar-widget">
                    <div class="widget-title">Topics</div>
                    <div class="flex flex-wrap gap-2">
                        {% for tag in tags %}
                        <a href="?tag={{ tag }}" class="tag-item">#{{ tag }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Newsletter -->
                <div class="p-5 bg-navy-900 rounded-sm border border-white/5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 h-px" style="background: linear-gradient(90deg, transparent, rgba(201,147,42,0.5) 50%, transparent);"></div>
                    <div class="w-8 h-8 bg-gold-500/15 border border-gold-500/30 rounded-sm flex items-center justify-center text-gold-400 text-sm mb-3">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <h4 class="font-semibold text-white text-sm mb-1">Newsletter</h4>
                    <p class="text-slate-500 text-xs mb-4 leading-relaxed">Get new articles delivered to your inbox.</p>
                    <form id="sidebar-newsletter-form">
                        {% csrf_token %}
                        <input type="email" name="email" placeholder="you@email.com" required
                               class="w-full px-3 py-2.5 bg-white/5 border border-white/10 rounded-sm text-white placeholder-slate-600 text-sm mb-2 focus:border-gold-500/50 focus:outline-none transition-all">
                        <button type="submit" class="w-full py-2.5 bg-gold-500/20 border border-gold-500/40 text-gold-400 hover:bg-gold-500 hover:text-navy-900 text-xs font-bold rounded-sm transition-all">
                            Subscribe
                        </button>
                    </form>
                </div>
                
                <!-- Recent Posts -->
                {% if recent_posts %}
                <div class="sidebar-widget">
                    <div class="widget-title">Recent</div>
                    <div class="space-y-3">
                        {% for post in recent_posts|slice:":5" %}
                        <div class="{% if not forloop.last %}pb-3 border-b border-slate-100 dark:border-white/5{% endif %}">
                            <a href="{{ post.get_absolute_url }}" class="text-sm font-semibold text-slate-800 dark:text-white hover:text-gold-600 dark:hover:text-gold-400 transition-colors leading-snug line-clamp-2 block mb-1">{{ post.title }}</a>
                            <span class="text-xs font-mono text-slate-400">{{ post.published_date|date:"M d, Y" }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// Newsletter
const snForm = document.getElementById('sidebar-newsletter-form');
snForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(snForm);
    const btn = snForm.querySelector('button');
    btn.textContent = 'Subscribing…'; btn.disabled = true;
    try {
        const res = await fetch('{% url "newsletter_subscribe" %}', {
            method: 'POST', body: fd,
            headers: { 'X-CSRFToken': fd.get('csrfmiddlewaretoken') }
        });
        const data = await res.json();
        btn.textContent = data.success ? '✓ Subscribed!' : 'Error — try again';
        if (data.success) { snForm.reset(); setTimeout(() => { btn.textContent = 'Subscribe'; btn.disabled = false; }, 3000); }
        else { btn.disabled = false; }
    } catch { btn.textContent = 'Error — try again'; btn.disabled = false; }
});
</script>
{% endblock %}