{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - {{ site_settings.site_name }}{% endblock %}
{% block meta_description %}{{ post.excerpt|default:post.content|truncatewords:30 }} — Blog post by {{ site_settings.site_name }}.{% endblock %}

{% block content %}

<!-- Blog Post Hero -->
<section class="relative pt-32 pb-24 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white overflow-hidden">
    <!-- Animated blobs (identical to reference) -->
    <div class="absolute inset-0 opacity-20">
        <div class="absolute top-10 left-10 w-96 h-96 bg-white rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
        <div class="absolute top-40 right-10 w-96 h-96 bg-yellow-200 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-40 w-96 h-96 bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-4000"></div>
    </div>

    <div class="container mx-auto px-4 relative z-10">
        <div class="max-w-4xl mx-auto text-center">
            <div class="inline-block px-5 py-3 bg-white/20 backdrop-blur-md rounded-full mb-8" data-aos="fade-down">
                <span class="text-base font-semibold">✍️ Blog Post</span>
            </div>
            <h1 class="text-5xl md:text-6xl lg:text-7xl font-display font-bold mb-8 leading-tight" data-aos="fade-up">
                {{ post.title }}
            </h1>

            {% if post.featured %}
            <span class="inline-block px-6 py-2 bg-yellow-500 text-white text-lg font-bold rounded-full mb-6 shadow-md" data-aos="zoom-in" data-aos-delay="200">
                Featured Article
            </span>
            {% endif %}

            <div class="flex flex-wrap justify-center gap-6 text-lg opacity-90" data-aos="fade-up" data-aos-delay="150">
                <span><i class="fas fa-calendar-alt mr-2"></i>{{ post.published_date|date:"F j, Y" }}</span>
                <span><i class="fas fa-clock mr-2"></i>{{ post.reading_time }} min read</span>
                <span><i class="fas fa-eye mr-2"></i>{{ post.views }} views</span>
                {% if post.author %}
                <span><i class="fas fa-user-circle mr-2"></i>{{ post.author }}</span>
                {% endif %}
            </div>

            {% if post.tags.all %}
            <div class="flex flex-wrap justify-center gap-3 mt-8" data-aos="fade-up" data-aos-delay="200">
                {% for tag in post.tags.all %}
                <span class="px-5 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-medium">
                    #{{ tag.name }}
                </span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Main Content + Sidebar -->
<section class="py-20 lg:py-28 bg-gray-50 dark:bg-gray-900">
    <div class="container mx-auto px-4">
        <div class="grid lg:grid-cols-3 gap-12 lg:gap-16 max-w-6xl mx-auto">
            <!-- Article Content -->
            <div class="lg:col-span-2" data-aos="fade-right">
                <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-8 lg:p-12 border border-gray-100 dark:border-gray-700/50">
                    {% if post.featured_image %}
                    <div class="rounded-2xl overflow-hidden mb-12 shadow-2xl">
                        <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" 
                             class="w-full h-auto object-cover">
                    </div>
                    {% endif %}

                    <div class="prose dark:prose-invert prose-xl max-w-none leading-relaxed mb-16">
                        {{ post.content|safe }}
                    </div>

                    <!-- Like Button -->
                    <div class="flex items-center justify-center gap-8 py-8 border-t border-gray-200 dark:border-gray-700">
                        <button id="like-btn" class="flex items-center gap-3 text-xl font-semibold text-gray-700 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 transition-colors" 
                                data-post-slug="{{ post.slug }}">
                            <i class="fas fa-heart {% if request.session.liked_posts|default:[] contains post.id %}text-red-500{% else %}text-gray-400{% endif %} text-2xl"></i>
                            <span id="like-count">{{ post.likes }}</span> Likes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div data-aos="fade-left">
                <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-8 border border-gray-100 dark:border-gray-700/50 sticky top-24">
                    <h3 class="text-2xl font-display font-bold mb-6 gradient-text">
                        Quick Info
                    </h3>

                    <ul class="space-y-6 text-lg mb-10">
                        <li class="flex items-center">
                            <i class="fas fa-calendar-alt mr-4 text-purple-600 dark:text-purple-400 text-xl"></i>
                            Published: {{ post.published_date|date:"F j, Y" }}
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-clock mr-4 text-purple-600 dark:text-purple-400 text-xl"></i>
                            {{ post.reading_time }} min read
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-eye mr-4 text-purple-600 dark:text-purple-400 text-xl"></i>
                            {{ post.views }} views
                        </li>
                        {% if post.author %}
                        <li class="flex items-center">
                            <i class="fas fa-user-circle mr-4 text-purple-600 dark:text-purple-400 text-xl"></i>
                            By {{ post.author }}
                        </li>
                        {% endif %}
                    </ul>

                    {% if post.tags.all %}
                    <div class="mb-10">
                        <h4 class="text-xl font-bold mb-4">Tags</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for tag in post.tags.all %}
                            <a href="?tag={{ tag.name|urlencode }}" 
                               class="px-4 py-2 bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 rounded-full text-sm hover:bg-purple-200 dark:hover:bg-purple-800/40 transition-colors">
                                #{{ tag.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <a href="{% url 'contact' %}" 
                       class="block text-center px-8 py-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full font-bold hover:shadow-2xl hover:scale-105 transition-all duration-300">
                        <i class="fas fa-envelope mr-3"></i> Discuss This Topic
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Comments Section -->
{% if post.allow_comments %}
<section class="py-20 lg:py-28 bg-white dark:bg-gray-950" id="comments">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-4xl lg:text-5xl font-display font-bold mb-12 text-center gradient-text" data-aos="fade-up">
                Comments
            </h2>

            {% if comments %}
            <div class="space-y-10">
                {% for comment in comments %}
                <div class="bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-6 lg:p-8 border border-gray-200 dark:border-gray-700/50" data-aos="fade-up">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 rounded-full bg-purple-100 dark:bg-purple-900/40 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-user text-purple-600 dark:text-purple-400 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-wrap justify-between items-baseline mb-2">
                                <h4 class="font-bold text-lg">{{ comment.name }}</h4>
                                <span class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ comment.created_at|timesince }} ago
                                </span>
                            </div>
                            <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
                                {{ comment.content|linebreaks }}
                            </p>
                        </div>
                    </div>

                    {% if comment.replies.exists %}
                    <div class="mt-6 pl-8 lg:pl-14 border-l-2 border-purple-200 dark:border-purple-800/40">
                        {% for reply in comment.replies.all %}
                        <div class="mt-6">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-reply text-gray-500 dark:text-gray-400 text-xl"></i>
                                </div>
                                <div>
                                    <div class="flex justify-between items-baseline mb-1">
                                        <span class="font-semibold">{{ reply.name }}</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">
                                            {{ reply.created_at|timesince }} ago
                                        </span>
                                    </div>
                                    <p class="text-gray-600 dark:text-gray-400">
                                        {{ reply.content|linebreaks }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-16 bg-gray-50 dark:bg-gray-800/50 rounded-3xl">
                <i class="fas fa-comments text-7xl text-gray-300 dark:text-gray-700 mb-6"></i>
                <h3 class="text-3xl font-bold mb-4">No Comments Yet</h3>
                <p class="text-lg text-gray-600 dark:text-gray-400">
                    Be the first to share your thoughts!
                </p>
            </div>
            {% endif %}

            <!-- Comment Form -->
            {% if comment_form %}
            <div class="mt-16 lg:mt-24 bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-8 lg:p-12 border border-gray-100 dark:border-gray-700/50" data-aos="fade-up">
                <h3 class="text-3xl lg:text-4xl font-display font-bold mb-8 gradient-text">
                    Leave a Comment
                </h3>

                <form method="post" class="space-y-6">
                    {% csrf_token %}

                    <div>
                        <label for="{{ comment_form.name.id_for_label }}" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Name</label>
                        {{ comment_form.name }}
                        {% if comment_form.name.errors %}
                        <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ comment_form.name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ comment_form.email.id_for_label }}" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Email</label>
                        {{ comment_form.email }}
                        {% if comment_form.email.errors %}
                        <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ comment_form.email.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ comment_form.content.id_for_label }}" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Comment</label>
                        {{ comment_form.content }}
                        {% if comment_form.content.errors %}
                        <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ comment_form.content.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <button type="submit" 
                            class="w-full px-8 py-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:shadow-2xl hover:scale-105 transition-all duration-300">
                        <i class="fas fa-comment-dots mr-3"></i> Post Comment
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}

<!-- Related Posts -->
{% if related_posts %}
<section class="py-20 lg:py-28 bg-gray-50 dark:bg-gray-900">
    <div class="container mx-auto px-4">
        <div class="text-center mb-16" data-aos="fade-up">
            <h2 class="text-5xl lg:text-6xl font-display font-bold mb-6">
                Related <span class="gradient-text">Articles</span>
            </h2>
            <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
                More insights you might enjoy
            </p>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-10 max-w-6xl mx-auto">
            {% for related in related_posts %}
            <div class="group" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1|mul:100 }}">
                <a href="{{ related.get_absolute_url }}" class="block h-full">
                    <div class="bg-white dark:bg-gray-800 rounded-3xl overflow-hidden shadow-xl hover:shadow-2xl transition-all duration-400 hover:-translate-y-3 border border-gray-100 dark:border-gray-700/50 h-full flex flex-col">
                        {% if related.featured_image %}
                        <div class="h-48 overflow-hidden">
                            <img src="{{ related.featured_image.url }}" alt="{{ related.title }}" 
                                 class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        </div>
                        {% endif %}

                        <div class="p-7 flex-grow flex flex-col">
                            <h3 class="text-2xl font-display font-bold mb-4 group-hover:gradient-text transition-colors line-clamp-2">
                                {{ related.title }}
                            </h3>

                            <p class="text-gray-600 dark:text-gray-400 mb-6 line-clamp-3 flex-grow">
                                {{ related.excerpt }}
                            </p>

                            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mt-auto">
                                <i class="fas fa-calendar mr-2"></i>{{ related.published_date|date:"M d, Y" }}
                                <span class="mx-3">•</span>
                                <i class="fas fa-clock mr-2"></i>{{ related.reading_time }} min
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA -->
<section class="py-24 lg:py-32 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center" data-aos="zoom-in">
            <h2 class="text-5xl lg:text-6xl font-display font-bold mb-8">
                Enjoyed This Article?
            </h2>
            <p class="text-2xl opacity-90 mb-10 max-w-3xl mx-auto">
                Want to discuss the topic, ask questions, or collaborate on a related project? I'm here.
            </p>
            <a href="{% url 'contact' %}" 
               class="inline-flex items-center px-12 py-6 bg-white text-blue-600 rounded-full font-bold text-xl hover:shadow-2xl hover:scale-105 transition-all duration-300">
                <i class="fas fa-envelope mr-3 text-2xl"></i> Get In Touch
            </a>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// Like button AJAX (compatible with blog_like view)
document.getElementById('like-btn')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const btn = e.currentTarget;
    const slug = btn.dataset.postSlug;
    const countEl = document.getElementById('like-count');

    try {
        const response = await fetch(`{% url 'blog_like' post.slug %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            btn.querySelector('i').classList.remove('text-gray-400');
            btn.querySelector('i').classList.add('text-red-500');
            countEl.textContent = data.likes;
        } else {
            alert(data.message || 'Already liked!');
        }
    } catch (err) {
        console.error('Like error:', err);
    }
});
</script>
{% endblock %}