{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} — {{ site_settings.site_name }}{% endblock %}
{% block meta_description %}{{ post.excerpt|default:post.content|truncatewords:30 }}{% endblock %}
{% block og_type %}article{% endblock %}

{% block extra_css %}
<style>
    /* Reading progress */
    #reading-progress { position: fixed; top: 0; left: 0; width: 0%; height: 2px; background: linear-gradient(90deg, #c9932a, #fbbf24); z-index: 9999; box-shadow: 0 0 6px rgba(201,147,42,0.5); transition: width 0.1s; }

    /* Hero */
    .post-hero { background: #0a0f2e; position: relative; overflow: hidden; }
    .post-hero-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(201,147,42,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(201,147,42,0.04) 1px, transparent 1px); background-size: 80px 80px; }
    .breadcrumb { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; flex-wrap: wrap; }
    .breadcrumb a { color: rgba(255,255,255,0.4); transition: color 0.2s; }
    .breadcrumb a:hover { color: #fbbf24; }
    .breadcrumb .sep { color: rgba(255,255,255,0.2); }
    .breadcrumb .current { color: #fbbf24; }

    /* Blog content typography */
    .blog-content { color: #334155; font-size: 1.05rem; line-height: 1.85; }
    .dark .blog-content { color: #cbd5e1; }
    .blog-content h2 { font-family: 'Playfair Display', serif; font-size: 1.75rem; font-weight: 700; margin: 2.5rem 0 1rem; color: #0f172a; scroll-margin-top: 6rem; }
    .dark .blog-content h2 { color: #f1f5f9; }
    .blog-content h3 { font-family: 'Playfair Display', serif; font-size: 1.375rem; font-weight: 700; margin: 2rem 0 0.75rem; color: #1e293b; scroll-margin-top: 6rem; }
    .dark .blog-content h3 { color: #e2e8f0; }
    .blog-content p { margin-bottom: 1.5rem; }
    .blog-content a { color: #c9932a; text-decoration: underline; text-underline-offset: 3px; text-decoration-color: rgba(201,147,42,0.3); }
    .blog-content a:hover { color: #a87520; }
    .blog-content ul, .blog-content ol { padding-left: 1.5rem; margin-bottom: 1.5rem; }
    .blog-content li { margin-bottom: 0.5rem; }
    .blog-content blockquote { border-left: 3px solid #c9932a; padding: 1rem 1.5rem; margin: 2rem 0; background: rgba(201,147,42,0.04); border-radius: 0 4px 4px 0; font-style: italic; color: #475569; }
    .dark .blog-content blockquote { background: rgba(201,147,42,0.06); color: #94a3b8; }
    .blog-content code { background: rgba(0,0,0,0.04); padding: 0.15em 0.45em; border-radius: 3px; font-family: 'DM Mono', monospace; font-size: 0.875em; color: #c9932a; border: 1px solid rgba(0,0,0,0.06); }
    .dark .blog-content code { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.08); color: #fbbf24; }
    .blog-content pre { background: #0f172a; padding: 1.5rem; border-radius: 4px; overflow-x: auto; margin: 2rem 0; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .blog-content pre code { background: transparent; padding: 0; border: none; color: #e2e8f0; font-size: 0.875rem; }
    .blog-content img { border-radius: 4px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); margin: 2rem auto; display: block; max-width: 100%; }

    /* TOC */
    .toc-link { display: block; padding: 0.35rem 0; font-size: 0.8rem; color: #64748b; transition: all 0.2s; border-left: 2px solid transparent; padding-left: 0.75rem; margin-left: -0.75rem; }
    .dark .toc-link { color: #94a3b8; }
    .toc-link:hover { color: #c9932a; border-left-color: rgba(201,147,42,0.4); }
    .toc-link.active { color: #c9932a; border-left-color: #c9932a; font-weight: 600; }
    .toc-h3 { padding-left: 1.5rem; font-size: 0.75rem; }

    /* Share buttons */
    .share-btn { width: 2.25rem; height: 2.25rem; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.875rem; transition: all 0.25s ease; }
    .share-btn:hover { transform: translateY(-2px); }

    /* Comments */
    .comment-card { padding: 1.5rem; border: 1px solid rgba(0,0,0,0.06); border-radius: 4px; background: white; }
    .dark .comment-card { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.07); }

    /* Comment form */
    .form-input { width: 100%; padding: 0.75rem 1rem; background: rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.1); border-radius: 4px; font-size: 0.875rem; font-family: 'DM Sans', sans-serif; color: #0f172a; transition: all 0.25s; outline: none; }
    .dark .form-input { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); color: #f1f5f9; }
    .form-input::placeholder { color: #94a3b8; }
    .form-input:focus { border-color: #c9932a; box-shadow: 0 0 0 3px rgba(201,147,42,0.08); }
    .form-label { display: block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; margin-bottom: 0.5rem; }
    .dark .form-label { color: #94a3b8; }

    /* Like button */
    #like-btn.liked i { color: #ef4444; }
    #like-btn:hover { transform: scale(1.05); }

    /* Sidebar info */
    .info-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(0,0,0,0.04); }
    .dark .info-item { border-color: rgba(255,255,255,0.04); }
    .info-item:last-child { border-bottom: none; }
    .info-icon { width: 2rem; height: 2rem; background: linear-gradient(135deg, #c9932a, #fbbf24); display: flex; align-items: center; justify-content: center; color: #0a0f2e; border-radius: 4px; flex-shrink: 0; font-size: 0.7rem; }

    /* Related post */
    .related-card { border-radius: 4px; overflow: hidden; background: white; border: 1px solid rgba(0,0,0,0.06); transition: all 0.3s ease; }
    .dark .related-card { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.07); }
    .related-card:hover { transform: translateY(-4px); box-shadow: 0 20px 60px rgba(0,0,0,0.1); border-color: rgba(201,147,42,0.2); }
    .related-card-img { overflow: hidden; aspect-ratio: 16/9; }
    .related-card-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
    .related-card:hover .related-card-img img { transform: scale(1.07); }

    @media (min-width: 1024px) { .sidebar-sticky { position: sticky; top: 6rem; } }
</style>
{% endblock %}

{% block content %}

<!-- Reading Progress -->
<div id="reading-progress"></div>

<!-- ==================== HERO ==================== -->
<section class="post-hero pt-28 pb-16">
    <div class="post-hero-grid"></div>
    <div class="absolute top-16 left-0 right-0 h-px" style="background: linear-gradient(90deg, transparent 5%, rgba(201,147,42,0.3) 50%, transparent 95%);"></div>
    
    <div class="relative z-10 max-w-4xl mx-auto px-6 lg:px-8">
        <nav class="breadcrumb mb-10" data-aos="fade-down">
            <a href="{% url 'home' %}">Home</a>
            <span class="sep">/</span>
            <a href="{% url 'blog' %}">Blog</a>
            <span class="sep">/</span>
            <span class="current">{{ post.title|truncatewords:5 }}</span>
        </nav>
        
        <!-- Category & meta -->
        <div class="flex flex-wrap items-center gap-3 mb-6" data-aos="fade-up">
            <span class="text-xs font-bold uppercase tracking-widest px-2.5 py-1 bg-gold-500/15 border border-gold-500/30 text-gold-400 rounded-sm">Article</span>
            {% if post.featured %}
            <span class="text-xs font-bold uppercase tracking-widest px-2.5 py-1 bg-gold-500 text-navy-900 rounded-sm">Featured</span>
            {% endif %}
        </div>
        
        <h1 class="font-display text-4xl md:text-5xl lg:text-6xl font-bold text-white leading-tight mb-8" data-aos="fade-up" data-aos-delay="80">
            {{ post.title }}
        </h1>
        
        <!-- Meta row -->
        <div class="flex flex-wrap items-center gap-6 text-sm text-slate-400 font-mono" data-aos="fade-up" data-aos-delay="140">
            <span>{{ post.published_date|date:"F j, Y" }}</span>
            <span class="w-px h-4 bg-white/10"></span>
            <span>{{ post.reading_time }} min read</span>
            <span class="w-px h-4 bg-white/10"></span>
            <span id="view-count">{{ post.views }} views</span>
            {% if post.author %}
            <span class="w-px h-4 bg-white/10"></span>
            <span>{{ post.author.get_full_name }}</span>
            {% endif %}
        </div>
        
        <!-- Tags -->
        {% if post.tags.all %}
        <div class="flex flex-wrap gap-2 mt-6" data-aos="fade-up" data-aos-delay="180">
            {% for tag in post.tags.all %}
            <a href="{% url 'blog' %}?tag={{ tag.name|urlencode }}" class="text-xs px-3 py-1 bg-white/5 border border-white/10 text-slate-400 hover:border-gold-500/40 hover:text-gold-400 transition-all rounded-sm font-mono">#{{ tag.name }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>

<!-- ==================== ARTICLE ==================== -->
<section class="py-16 bg-white dark:bg-navy-950">
    <div class="max-w-7xl mx-auto px-6 lg:px-8">
        <div class="grid lg:grid-cols-4 gap-10">
            
            <!-- Article Content (3 cols) -->
            <article class="lg:col-span-3" data-aos="fade-right">
                
                <!-- Featured Image -->
                {% if post.featured_image %}
                <div class="rounded-sm overflow-hidden mb-10 shadow-xl">
                    <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="w-full">
                </div>
                {% endif %}
                
                <!-- Content -->
                <div class="blog-content">
                    {{ post.content|safe }}
                </div>
                
                <!-- Like & Share -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-6 py-8 mt-12 border-t border-b border-slate-100 dark:border-white/5">
                    <!-- Like -->
                    <button id="like-btn" class="flex items-center gap-3 transition-all duration-300 group {% if user_has_liked %}liked{% endif %}" data-post-slug="{{ post.slug }}">
                        <div class="w-10 h-10 border border-slate-200 dark:border-white/10 rounded-sm flex items-center justify-center group-hover:border-red-300 dark:group-hover:border-red-700 transition-colors">
                            <i class="{% if user_has_liked %}fas{% else %}far{% endif %} fa-heart text-sm {% if user_has_liked %}text-red-500{% else %}text-slate-400 group-hover:text-red-400{% endif %} transition-colors"></i>
                        </div>
                        <span class="text-sm">
                            <span id="like-count" class="font-bold text-slate-900 dark:text-white">{{ post.likes }}</span>
                            <span class="text-slate-400 ml-1">likes</span>
                        </span>
                    </button>
                    
                    <!-- Share -->
                    <div class="flex items-center gap-3">
                        <span class="text-xs uppercase tracking-widest text-slate-400 font-semibold mr-2">Share</span>
                        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title|urlencode }}" target="_blank" class="share-btn bg-sky-50 dark:bg-sky-900/20 text-sky-600 dark:text-sky-400 hover:bg-sky-500 hover:text-white" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" target="_blank" class="share-btn bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-600 hover:text-white" aria-label="LinkedIn">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="share-btn bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 hover:bg-blue-700 hover:text-white" aria-label="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <button onclick="copyUrl()" class="share-btn bg-slate-100 dark:bg-white/5 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-white/10" aria-label="Copy link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Author Bio -->
                {% if post.author %}
                <div class="mt-10 p-6 border border-slate-100 dark:border-white/5 rounded-sm flex items-start gap-5">
                    <div class="w-14 h-14 rounded-sm bg-gold-500/15 border border-gold-500/30 flex items-center justify-center text-xl font-bold text-gold-600 flex-shrink-0 font-display">
                        {{ post.author.first_name|first }}{{ post.author.last_name|first }}
                    </div>
                    <div>
                        <div class="text-xs font-semibold uppercase tracking-widest text-gold-500 mb-1">Author</div>
                        <h3 class="font-display text-lg font-bold text-slate-900 dark:text-white mb-2">{{ post.author.get_full_name }}</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                            {% if post.author.profile.bio %}{{ post.author.profile.bio }}{% else %}Passionate developer and writer sharing insights about technology and software development.{% endif %}
                        </p>
                    </div>
                </div>
                {% endif %}
                
                <!-- Comments -->
                {% if post.allow_comments %}
                <div class="mt-16" id="comments">
                    <div class="flex items-center gap-4 mb-8">
                        <h2 class="font-display text-2xl font-bold text-slate-900 dark:text-white">
                            Comments {% if comments %}<span class="text-slate-400 font-normal text-lg">({{ comments|length }})</span>{% endif %}
                        </h2>
                        <div class="flex-1 h-px bg-slate-100 dark:bg-white/5"></div>
                    </div>
                    
                    {% if comments %}
                    <div class="space-y-5 mb-12">
                        {% for comment in comments %}
                        <div class="comment-card">
                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 rounded-sm bg-gold-500/10 border border-gold-500/20 flex items-center justify-center text-sm font-bold text-gold-600 font-display flex-shrink-0">{{ comment.name|first }}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-2 mb-2">
                                        <span class="font-semibold text-sm text-slate-900 dark:text-white">{{ comment.name }}</span>
                                        <span class="text-xs font-mono text-slate-400">{{ comment.created_at|timesince }} ago</span>
                                    </div>
                                    <div class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">{{ comment.content|linebreaks }}</div>
                                </div>
                            </div>
                            
                            {% if comment.replies.exists %}
                            <div class="mt-4 pl-8 border-l-2 border-slate-100 dark:border-white/5 space-y-3">
                                {% for reply in comment.replies.all %}
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 rounded-sm bg-navy-50 dark:bg-white/5 flex items-center justify-center text-xs font-bold text-navy-600 dark:text-slate-400 flex-shrink-0">{{ reply.name|first }}</div>
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-semibold text-xs text-slate-800 dark:text-white">{{ reply.name }}</span>
                                            <span class="text-xs font-mono text-slate-400">{{ reply.created_at|timesince }} ago</span>
                                        </div>
                                        <div class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">{{ reply.content }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12 border border-dashed border-slate-200 dark:border-white/5 rounded-sm mb-10">
                        <i class="fas fa-comments text-2xl text-slate-300 dark:text-white/20 mb-3 block"></i>
                        <p class="text-sm text-slate-400">Be the first to share your thoughts</p>
                    </div>
                    {% endif %}
                    
                    <!-- Comment form -->
                    {% if comment_form %}
                    <div class="p-6 border border-slate-100 dark:border-white/5 rounded-sm">
                        <h3 class="font-display text-xl font-bold text-slate-900 dark:text-white mb-6">Leave a Comment</h3>
                        <form method="post" action="{% url 'blog_comment_submit' post.slug %}" id="comment-form" class="space-y-4">
                            {% csrf_token %}
                            <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off">
                            <div class="grid sm:grid-cols-2 gap-4">
                                <div><label class="form-label">Name <span class="text-gold-500">*</span></label><input type="text" name="name" required placeholder="Your name" class="form-input"></div>
                                <div><label class="form-label">Email <span class="text-gold-500">*</span></label><input type="email" name="email" required placeholder="you@example.com" class="form-input"></div>
                            </div>
                            <div><label class="form-label">Comment <span class="text-gold-500">*</span></label><textarea name="content" rows="5" required placeholder="Share your thoughts…" class="form-input resize-none"></textarea></div>
                            <button type="submit" class="btn-primary"><span>Post Comment</span> <i class="fas fa-paper-plane text-xs"></i></button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </article>
            
            <!-- Sidebar -->
            <div class="sidebar-sticky space-y-6" data-aos="fade-left">
                
                <!-- Quick Info -->
                <div class="p-5 border border-slate-100 dark:border-white/5 rounded-sm bg-white dark:bg-transparent">
                    <div class="text-xs font-bold uppercase tracking-widest text-gold-500 mb-4">Article Info</div>
                    <div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-calendar"></i></div><div><div class="text-xs text-slate-400">Published</div><div class="text-xs font-semibold text-slate-800 dark:text-white">{{ post.published_date|date:"F j, Y" }}</div></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-clock"></i></div><div><div class="text-xs text-slate-400">Reading Time</div><div class="text-xs font-semibold text-slate-800 dark:text-white">{{ post.reading_time }} minutes</div></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-eye"></i></div><div><div class="text-xs text-slate-400">Views</div><div class="text-xs font-semibold text-slate-800 dark:text-white">{{ post.views }}</div></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-heart"></i></div><div><div class="text-xs text-slate-400">Likes</div><div class="text-xs font-semibold text-slate-800 dark:text-white" id="sidebar-like-count">{{ post.likes }}</div></div></div>
                    </div>
                </div>
                
                <!-- Tags -->
                {% if post.tags.all %}
                <div class="p-5 border border-slate-100 dark:border-white/5 rounded-sm bg-white dark:bg-transparent">
                    <div class="text-xs font-bold uppercase tracking-widest text-gold-500 mb-4">Tags</div>
                    <div class="flex flex-wrap gap-2">
                        {% for tag in post.tags.all %}
                        <a href="{% url 'blog' %}?tag={{ tag.name|urlencode }}" class="text-xs px-2.5 py-1 border border-slate-200 dark:border-white/10 rounded-sm text-slate-600 dark:text-slate-400 hover:border-gold-500/40 hover:text-gold-600 dark:hover:text-gold-400 transition-all font-mono">#{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- TOC -->
                <div id="toc-container" class="p-5 border border-slate-100 dark:border-white/5 rounded-sm bg-white dark:bg-transparent" style="display:none;">
                    <div class="text-xs font-bold uppercase tracking-widest text-gold-500 mb-4">Contents</div>
                    <nav id="table-of-contents" class="space-y-0.5"></nav>
                </div>
                
                <!-- CTA -->
                <div class="p-5 bg-navy-900 border border-white/5 rounded-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 h-px" style="background: linear-gradient(90deg, transparent, rgba(201,147,42,0.5) 50%, transparent);"></div>
                    <div class="text-xs font-bold uppercase tracking-widest text-gold-500 mb-3">Discuss This</div>
                    <p class="text-slate-400 text-xs leading-relaxed mb-4">Have questions about this topic? Let's connect and dig deeper.</p>
                    <a href="{% url 'contact' %}" class="block text-center py-2.5 bg-gold-500/15 border border-gold-500/30 text-gold-400 hover:bg-gold-500 hover:text-navy-900 text-xs font-bold rounded-sm transition-all">Get in Touch</a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ==================== RELATED POSTS ==================== -->
{% if related_posts %}
<section class="py-20 bg-slate-50 dark:bg-navy-900/30">
    <div class="max-w-7xl mx-auto px-6 lg:px-8">
        <div class="flex items-center gap-4 mb-10" data-aos="fade-up">
            <h2 class="font-display text-3xl font-bold text-slate-900 dark:text-white">Related <span class="text-gold">Articles</span></h2>
            <div class="flex-1 h-px bg-slate-200 dark:bg-white/5"></div>
        </div>
        <div class="grid md:grid-cols-3 gap-6">
            {% for related in related_posts %}
            <article class="related-card group" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:'1' }}00">
                <a href="{{ related.get_absolute_url }}">
                    <div class="related-card-img">
                        {% if related.featured_image %}<img src="{{ related.featured_image.url }}" alt="{{ related.title }}" loading="lazy">
                        {% else %}<div class="w-full h-full bg-navy-800 flex items-center justify-center"><i class="fas fa-newspaper text-3xl text-white/20"></i></div>{% endif %}
                    </div>
                    <div class="p-5">
                        <div class="font-mono text-xs text-slate-400 mb-2">{{ related.published_date|date:"M d, Y" }} · {{ related.reading_time }} min</div>
                        <h3 class="font-display text-base font-bold text-slate-900 dark:text-white mb-2 leading-snug group-hover:text-gold-600 dark:group-hover:text-gold-400 transition-colors line-clamp-2">{{ related.title }}</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2">{{ related.excerpt }}</p>
                    </div>
                </a>
            </article>
            {% endfor %}
        </div>
        <div class="text-center mt-10">
            <a href="{% url 'blog' %}" class="btn-outline mx-auto"><i class="fas fa-arrow-left text-xs"></i> All Articles</a>
        </div>
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Reading progress
let rp = false;
window.addEventListener('scroll', () => {
    if (!rp) { rp = true; requestAnimationFrame(() => {
        const pct = (window.scrollY / (document.documentElement.scrollHeight - innerHeight)) * 100;
        document.getElementById('reading-progress').style.width = Math.min(pct, 100) + '%';
        rp = false;
    }); }
}, { passive: true });

// Like button
const likeBtn = document.getElementById('like-btn');
likeBtn?.addEventListener('click', async () => {
    if (likeBtn.disabled) return;
    likeBtn.disabled = true;
    try {
        const res = await fetch(`/blog/{{ post.slug }}/like/`, {
            method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('like-count').textContent = data.likes;
            document.getElementById('sidebar-like-count').textContent = data.likes;
            likeBtn.classList.add('liked');
            const icon = likeBtn.querySelector('i');
            icon.classList.remove('far'); icon.classList.add('fas', 'text-red-500');
        }
    } catch(e) { console.error(e); }
    finally { likeBtn.disabled = false; }
});

// Copy URL
function copyUrl() {
    navigator.clipboard.writeText(location.href).then(() => {
        const el = document.createElement('div');
        el.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-5 py-2.5 bg-navy-900 text-gold-400 text-xs font-semibold rounded-sm border border-gold-500/30 shadow-xl';
        el.textContent = 'Link copied to clipboard';
        document.body.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.3s'; setTimeout(() => el.remove(), 300); }, 2500);
    });
}

// Table of Contents
function buildTOC() {
    const headings = document.querySelectorAll('.blog-content h2, .blog-content h3');
    if (headings.length < 2) return;
    const toc = document.getElementById('table-of-contents');
    const container = document.getElementById('toc-container');
    
    headings.forEach((h, i) => {
        h.id = h.id || `section-${i}`;
        const a = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent;
        a.className = 'toc-link' + (h.tagName === 'H3' ? ' toc-h3' : '');
        a.addEventListener('click', (e) => {
            e.preventDefault();
            h.scrollIntoView({ behavior: 'smooth' });
        });
        toc.appendChild(a);
    });
    container.style.display = 'block';
    
    // Highlight active
    const obsOptions = { rootMargin: '-80px 0px -60% 0px' };
    const tocObs = new IntersectionObserver((entries) => {
        entries.forEach(e => {
            const link = toc.querySelector(`[href="#${e.target.id}"]`);
            if (link) link.classList.toggle('active', e.isIntersecting);
        });
    }, obsOptions);
    headings.forEach(h => tocObs.observe(h));
}
buildTOC();
</script>
{% endblock %}